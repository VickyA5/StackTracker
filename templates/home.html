{% extends 'base.html' %}
{% block content %}
  <style>
    .supplier-card { position: relative; }
    .menu-btn { min-width:auto !important; width:auto !important; padding:8px 10px; display:inline-flex; align-items:center; justify-content:center; background:#374151; color:#e5e7eb; }
    .menu-btn svg { width:16px; height:16px; }
    .menu-dropdown { position:absolute; right:12px; top:48px; background:#111827; border:1px solid #1f2937; border-radius:8px; min-width:180px; padding:8px; display:none; z-index:5; }
    .menu-dropdown.open { display:block; }
    .menu-item { display:flex; align-items:center; gap:8px; padding:8px; border-radius:6px; color:#e5e7eb; text-decoration:none; }
    .menu-item:hover { background:#1f2937; text-decoration:none; }
    .menu-item.destructive { color:#fecaca; }
    .menu-item.destructive:hover { background:#5b1212; }
    .menu-item svg { width:16px; height:16px; }
    .btn.secondary.btn-compact {
      min-width:140px;
      width:auto;
      padding:12px 16px;
      flex:0 0 auto;
    }
  </style>
  <div class="centered">
    <h1 style="margin-top:0">Welcome, {{ user.username }}</h1>
    <p class="subtitle">You can add a new supplier or select an existing one to compare stock levels.</p>
    <div style="margin-top:24px; display:flex; gap:12px; justify-content:center; flex-wrap:wrap;">
      <a class="btn" href="{% url 'supplier_create' %}" aria-label="Create Supplier">
        <svg aria-hidden="true" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right:8px;">
          <path d="M12 5v14M5 12h14"/>
        </svg>
        Create Supplier
      </a>
    </div>
    <hr style="margin-top:20px; border-color:#1f2937;" />
    <div style="margin-top:12px;">
      <h3 style="margin-bottom:8px">Your suppliers</h3>
      <div style="display:flex; flex-direction:column; gap: 12px;">
        {% for s in suppliers %}
          <section class="supplier-card" style="width:100%; background:#111827; border:1px solid #1f2937; border-radius:8px; padding:16px; position:relative;">
            <div style="display:flex; align-items:center; justify-content:space-between; gap:8px; flex-wrap:wrap;">
              <strong style="font-size:16px;">{{ s.name }}</strong>
              <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;">
                <a class="btn" href="{% url 'supplier_upload' s.id %}">Upload Excel</a>
                <a class="btn secondary btn-compact" href="{% url 'supplier_last_comparison' s.id %}">Last Comparison</a>
                <button type="button" class="btn secondary menu-btn" aria-haspopup="true" aria-expanded="false" title="More actions">
                  <svg aria-hidden="true" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="5" cy="12" r="1"/>
                    <circle cx="12" cy="12" r="1"/>
                    <circle cx="19" cy="12" r="1"/>
                  </svg>
                </button>
              </div>
            </div>
            <div class="menu-dropdown" role="menu" aria-label="Supplier actions">
              <a class="menu-item" href="{% url 'supplier_settings' s.id %}" role="menuitem" aria-label="Edit columns">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M16.5 3.5a2.121 2.121 0 1 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/>
                </svg>
                <span>Edit columns</span>
              </a>
              <a class="menu-item destructive" href="{% url 'supplier_delete' s.id %}" role="menuitem" aria-label="Delete supplier">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <polyline points="3 6 5 6 21 6"/>
                  <path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/>
                  <path d="M10 11v6M14 11v6"/>
                  <path d="M9 6V4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"/>
                </svg>
                <span>Delete supplier</span>
              </a>
            </div>
            <div class="muted" style="margin-top:6px; text-align:left;">Last file: {% if s.last_uploaded_filename %}{{ s.last_uploaded_filename }}{% else %}No file uploaded yet{% endif %}</div>
            {% if s.current_file %}
              <div class="muted" style="margin-top:6px; font-size:12px; text-align:left;">Last updated: {{ s.updated_at|date:"Y-m-d H:i" }}</div>
            {% endif %}
          </section>
        {% empty %}
          <p>No suppliers yet. Use "Create Supplier" to add one.</p>
        {% endfor %}
      </div>
    </div>
  </div>
  <script>
    (function() {
      function closeAll() {
        document.querySelectorAll('.menu-dropdown').forEach(dd => dd.classList.remove('open'));
        document.querySelectorAll('.menu-btn').forEach(btn => btn.setAttribute('aria-expanded', 'false'));
      }
      document.addEventListener('click', function(e) {
        const btn = e.target.closest('.menu-btn');
        if (btn) {
          const card = btn.closest('.supplier-card');
          const dropdown = card.querySelector('.menu-dropdown');
          const isOpen = dropdown.classList.contains('open');
          closeAll();
          if (!isOpen) {
            dropdown.classList.add('open');
            btn.setAttribute('aria-expanded', 'true');
          }
          return;
        }
        // Close when clicking outside of any dropdown/card
        if (!e.target.closest('.menu-dropdown')) {
          closeAll();
        }
      });
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') closeAll();
      });
    })();
  </script>
  {% endblock %}
